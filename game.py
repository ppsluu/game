# Основной файл игры «АРТЕФАКТЫ»
# Здесь лежит игровой цикл, бои, сюжетные ветки и работа с пользователем
# (регистрация, вход, загрузка сохранений)


import os       # работа с файловой системой (проверка наличия сохранений, users.txt)
import random   # случайный урон/лечение, шанс потери артефакта

from player import P      # класс игрока
from artifacts import ABox  # коробка с артефактами

def mini_battle(p, enemy_name="монстр", enemy_hp=30):

    # Мини-бой с врагом брала из лабы
    # p - объект игрока (класс P)
    # enemy_name - строка с именем врага (для текста)
    # enemy_hp - стартовое HP врага
    # Пищет True, если игрок победил, и False, если проиграл

    heal_cost = 15
    print("\nМИНИ-БОЙ")
    print(f"На твоем пути {enemy_name}!")
    print(f"\nТвой уровень: {p.lvl}, HP: {p.hp}/{p.max_hp}, мана: {p.mana}/{p.max_mana}")
    print(f"HP врага: {enemy_hp}")

    while enemy_hp > 0 and p.hp > 0:
        print("\nТвои действия:")
        print("1. Атаковать")
        print("2. Защищаться")
        print("3. Подлечиться")
        choice = input("Выбор: ")

        if choice == '1':
            dmg = random.randint(5, 10) + p.lvl
            enemy_hp -= dmg
            print(f"Ты ударил {enemy_name} и нанес {dmg} урона!")
        elif choice == '2':
            print("Ты попытался защититься и приготовился к удару.")
        elif choice == '3':
            if p.mana < heal_cost:
                print(f"Не хватает маны (нужно {heal_cost}, у тебя {p.mana}).")
            else:
                p.mana -= heal_cost
                heal = random.randint(12, 20)
                old_hp = p.hp
                p.hp = min(p.max_hp, p.hp + heal)
                print(f"Ты лечишься: было {old_hp} HP, стало {p.hp} HP. Мана: {p.mana}/{p.max_mana}")
        else:
            print("Ты думаешь и теряешь инициативу...")

        if enemy_hp <= 0:
            break
        enemy_dmg = random.randint(6, 14)
        if choice == '2':
            enemy_dmg = max(1, enemy_dmg // 3)  # блок сильнее режет урон
        p.hp -= enemy_dmg
        print(f"{enemy_name} атакует и наносит тебе {enemy_dmg} урона!")
        print(f"Твой HP: {p.hp}/{p.max_hp}, мана: {p.mana}/{p.max_mana}, HP врага: {enemy_hp}")

    if p.hp <= 0:
        print("\nТы пал в бою...")
        print("Тебя оттаскивают в безопасное место, но силы на исходе.")
        if p.art and random.random() < 0.3:
            lost = random.choice(p.art)
            p.art.remove(lost)
            print(f"В суматохе ты потерял артефакт «{lost}».")
        p.hp = max(10, p.max_hp // 4)
        p.mana = max(10, p.max_mana // 3)
        p.branch = 0
        p.prog = 0
        return False

    print(f"\nТы победил {enemy_name}!")
    p.lvl += 1
    p.max_hp += 3
    p.max_mana += 3
    p.hp = min(p.max_hp, p.hp + 10)
    p.mana = min(p.max_mana, p.mana + 10)
    print(f"Ты повысил уровень до {p.lvl}! Максимальное HP: {p.max_hp}, мана: {p.mana}/{p.max_mana}, текущее HP: {p.hp}")
    return True

def trade_art_for_hp(p, ab):
    # Обменять один артефакт из инвентаря игрока на фиксированное количество HP
    # p - игрок
    # ab - коробка артефактов (ABox), туда мы вернём отданный предмет

    if not p.art:
        print("\nУ тебя нет артефактов для обмена.")
        return
    print("\nОБМЕН АРТЕФАКТА НА HP")
    for i, art in enumerate(p.art, 1):
        print(i, "-", art)
    print("0 - ничего не менять")
    choice = input("Номер артефакта: ")

    if not choice.isdigit():
        print("Это не число.")
        return
    choice = int(choice)

    if choice == 0:
        print("Передумал обменивать.")
        return

    if choice < 1 or choice > len(p.art):
        print("Нет такого артефакта.")
        return

    art = p.art.pop(choice - 1)   # забираем артефакт у игрока
    ab.return_art([art])          # кладём его обратно в коробку
    heal = 20                     # фиксированное лечение
    p.hp += heal
    if p.hp > p.max_hp:
        p.hp = p.max_hp

    print(f"Ты отдал '{art}' и вылечился на {heal} HP.")
    print(f"HP сейчас: {p.hp}/{p.max_hp}")

def reg():
    # Регистрация нового пользователя.
    # Сохраняет логин и пароль в файл users.txt в формате "лог:пароль"
    # Возвращает логин, если регистрация прошла успешно,иначе будет None
    login = input("Логин: ")
    if os.path.exists('users.txt'):
        with open('users.txt', 'r', encoding='utf-8') as f:
            for line in f:
                parts = line.strip().split(':')
                if len(parts) == 2 and parts[0] == login:
                    print("Логин занят!")
                    return None
    pwd = input("Пароль: ")
    with open('users.txt', 'a', encoding='utf-8') as f:
        f.write(f"{login}:{pwd}\n")
    print("Регистрация успешна!")
    return login

def auth():
    # Авторизация пользователя по логину и паролю
    # Читает users.txt и проверяет пару логин/пароль
    # Возвращает логин при успешном входе, иначе будетNone

    login = input("Логин: ")
    pwd = input("Пароль: ")
    if os.path.exists('users.txt'):
        with open('users.txt', 'r', encoding='utf-8') as f:
            for line in f:
                parts = line.strip().split(':')
                if len(parts) == 2 and parts[0] == login and parts[1] == pwd:
                    print("Вход успешен!")
                    return login
    print("Неверный логин/пароль!")
    return None

def main_menu():
    # Показать главное меню (до входа в игру) и вернуть выбор пользователя
    print("\nГЛАВНОЕ МЕНЮ")
    print("1. Регистрация")
    print("2. Вход")
    print("3. Выход")
    ch = input("Выбор: ")
    return ch

def branch_1(p, ab):
    # Сюжетная ветка 1 — ЛЕС.
    # Внутри по полю p.prog отслеживаются подэтапы этой ветки
    print("\nЛЕС")
    if p.prog == 0:
        print("Ты в темном-темном лесу. Видишь дорогу налево и направо.")
        print("Ты: Куда пойти? ВЫБЕРИ: лево или право...")
        print("1. Идти налево")
        print("2. Идти направо")
        ch = input("Выбор: ")
        if ch == '1':
            p.prog = 1
            print("Нашел старый меч! Но на пути к нему враг...")
            print("\nПеред тобой стоит Детпул — бывший наемник, который потерял всё из-за проклятия бессмертия. Он бродит по лесу, собирая оружие, которое когда-то принадлежало его жертвам.")
            print("\nДетпул: О, новый герой! Знаешь, время течет по-другому, когда ты не можешь умереть...")
            print("Детпул: Ой, а это меч? Мне он очень нужен, если понимаешь о чем я.")
            print("Ты: Понимаю, но мне он нужен. Видишь, у меня завтра экзамен по информатике, и я слышал, что этот меч помогает сдавать экзамены.")
            print("Детпул: Экзамен? Ха! Я помню, как сдавал экзамены... нет, не помню. Время стирает память, когда ты бессмертен. Но ладно, если хочешь драться — давай! Мне всё равно скучно, а драка развеет скуку.")
            print("Детпул: Наконец-то что-то интересное! Давай покажем, кто тут круче!")
            if not mini_battle(p, "Детпул", 35):
                return
            art = ab.take('меч')
            if art:
                p.add_art(art)
        elif ch == '2':
            p.prog = 2
            print("Нашел ключ! Но сначала нужно отбиться от мага времени...")
            print("\nДоктор Стрендж — могущественный маг, который охраняет древний ключ от портала в другие измерения. Он считает, что только избранные достойны владеть такой силой.")
            print("\nДок Стрендж: Стоп! Ты не должен быть здесь. Этот ключ — не игрушка для простых смертных.")
            print("Док Стрендж: Я видел четырнадцать миллионов шестьсот пять возможных исходов, и в большинстве из них ты проигрываешь.")
            print("Ты: А в остальных? Что происходит в тех редких случаях, когда я выигрываю?")
            print("Док Стрендж: В остальных... тоже проигрываешь, но более эпично. Этот ключ может открыть врата в миры, которые тебе не понять. Вспомни Питера Паркера.")
            print("Ты: Понимаю твои опасения, но мне действительно нужен этот ключ. У меня завтра важный экзамен, и библиотека закрыта. Этот ключ — единственный способ попасть туда.")
            print("Док Стрендж: Библиотеку? Ты серьезно? Ты хочешь использовать магический артефакт, чтобы попасть в библиотеку?")
            print("Док Стрендж: Пусть магия решит, кто достоин!")
            if not mini_battle(p, "Док Стрендж", 30):
                return
            art = ab.take('ключ')
            if art:
                p.add_art(art)
    elif p.prog == 1:
        print("Ты уже на левой тропе. Впереди пещера.")
        print("Ты: Там темно... но, может, там сокровища. Надеюсь не зря туда иду...")
        print("1. Зайти в пещеру")
        print("2. Обойти пещеру")
        ch = input("Выбор: ")
        if ch == '1':
            p.prog = 3
            print("В пещере прячется кто-то, охраняющий щит!")
            print("\nТаннос — титан, который когда-то пытался уничтожить половину вселенной. Теперь он скрывается в пещере, охраняя свой щит — последнее напоминание о его былой силе (ведь он лох - перчатку потерял).")
            print("\nТаннос: Ты пришел за моим щитом? Интересно... многие пытались, но все они стали пылью, в свое время я стёр с лица вселенной 50% живых существ...")
            print("Таннос: Ирония судьбы — теперь я защищаю один жалкий щит в этой пещере, как наказание.")
            print("Ты: Мне нужен этот щит. Не для уничтожения вселенной, просто для защиты на экзамене, мне реально страшно. Я преподов боюсь.")
            print("Таннос: Экзамен? Ха! Ты думаешь, что твои проблемы важны? Я видел, как умирают целые планеты! Твоё волнение — это пыль в космосе!")
            print("Ты: Может быть, но для меня это важно. И если ты стоишь на моем пути — значит, моя проблема сейчас — это ты.")
            print("Таннос: Хорошо сказано. Решимость... я помню, что это такое. Но слова ничего не значат без силы. Покажи, на что способен, и тогда мы увидим, достоин ли ты этого щита!")
            print("Таннос: Я сама неотвратимость!")
            if not mini_battle(p, "Таннос", 50):
                return
            art = ab.take('щит')
            if art:
                p.add_art(art)
        elif ch == '2':
            p.prog = 4
            print("Обойдя пещеру, ты избежал боя и нашел книгу! Ты крутой! Всё должно решаться словами, а не кулаками, жаль только тз игры на это нацеленно..")
            print("Ты: Круто, и драться не пришлось, респект разрабу.")
            art = ab.take('книга')
            if art:
                p.add_art(art)
    elif p.prog == 2:
        print("Ты на правой тропе. Видишь мост через реку.")
        print("Ты: Мост выглядит не очень надежно...")
        print("1. Перейти мост")
        print("2. Идти вдоль реки")
        ch = input("Выбор: ")
        if ch == '1':
            p.prog = 5
            print("На мосту тебя поджидает Аллая Ведьма! (не люблю её в квм, мочи её плиз, она правда сильная)")
            print("\nАллая Ведьма — древняя колдунья, могущественная мутантка, способная изменять реальность силой своего разума и эмоций.")
            print("\nАллая Ведьма: О, новая сила... сколько лет я ждала кого-то, кто осмелится мне противостоять, я так устала быть запечатанной в Даркхолде...")
            print("Аллая Ведьма: Когда-то я была как ты — молодая, полная надежд. Но любовь к иллюзиям привела меня сюда. Теперь я вечный страж.")
            print("Ты: Мне жаль слышать твою историю, но мне действительно нужно перейти мост. У меня важное дело по ту сторону.")
            print("Аллая Ведьма: Все хотят перейти мост. Но плата высока — твоя жизнь или твоя душа. Что выберешь, герой?")
            print("Ты: Я не хочу отдавать ни жизнь, ни душу. Я выберу третий вариант — драться и пройти этот уровень.")
            print("Аллая Ведьма: Смелость или глупость? Узнаем скоро. Но помни — я не прощаю тех, кто пытается обмануть судьбу! И я не проигрываю легко!")
            print("Аллая Ведьма: Пусть твоя душа станет частью Даркхолда!")
            if not mini_battle(p, "Аллая Ведьма", 60):
                return
            print("Перешел мост, нашел лук!")
            art = ab.take('лук')
            if art:
                p.add_art(art)
        elif ch == '2':
            p.prog = 6
            print("Шел вдоль реки, нашел кольцо!")
            print("Ты: 'Моё сокровище...' - прошептал ты невольно, поднимая Кольцо Всевластья.")
            art = ab.take('кольцо')
            if art:
                p.add_art(art)
    else:
        print("Ветка завершена! Возврат в меню.")
        p.branch = 0
        p.prog = 0

def branch_2(p, ab):
    # Сюжетная ветка 2 — ГОРОД
    print("\nГОРОД")
    if p.prog == 0:
        print("Ты в большом городе. Куда пойдешь?")
        print("Ты: Столько людей... даже немного страшно.")
        print("1. В таверну")
        print("2. На рынок")
        ch = input("Выбор: ")
        if ch == '1':
            p.prog = 1
            print("В таверне на тебя нападает пьяный студент!")
            print("\nМаёвец — студент, который уже третий год пытается сдать сессию. Отчаяние и алкоголь превратили его в агрессивного забияку, который нападает на всех, кто выглядит умнее него.")
            print("\nМаёвец: Эй, ты! Ты чё такой умный? Я вижу, у тебя книжки в рюкзаке, там должны быть бутылки!")
            print("Маёвец: Я тут уже третий год сижу, понимаешь? Третий! А ты пришел, такой весь умный, с книжками в рюкзаке, сдал всё с первого раза, наверное? А теперь на стипухе сидишь?")
            print("Ты: Я просто хочу посидеть и отдохнуть. У меня тоже завтра экзамен, и я устал.")
            print("Маёвец: Отдохнуть? А я не могу отдохнуть! У меня завтра комиссия, а я ничего не знаю! Три года пытаюсь сдать, и ничего! И знаешь что? Я тебя ненавижу за то, что ты всё знаешь!")
            print("Ты: Я не хочу драться... Может, лучше вместе подготовимся?")
            print("Маёвец: Нет! А я хочу! Может, если я тебя побью, хоть что-то получится в моей жизни! Хоть одна победа!")
            print("Маёвец: За мою стипендию и Б-52!")
            if not mini_battle(p, "пьяный студент", 70):
                return
            print("После драки ты забрал его стипендию и получил посох!")
            art = ab.take('посох')
            if art:
                p.add_art(art)
        elif ch == '2':
            p.prog = 2
            print("На рынке тебя пытаются ограбить!")
            print("\nКоллекторы — группа бывших студентов, которые не смогли выплатить кредит на обучение. Теперь они грабят других студентов, чтобы вернуть свои долги.")
            print("\nКоллекторы: О, смотрите, ребята! Новый первак с полными карманами!")
            print("Коллектор 1: Мы когда-то были как ты — верили, что образование поможет. Но кредит... кредит всё испортил. Теперь мы в долгах на всю жизнь.")
            print("Коллектор 2: Теперь мы собираем долги с таких же, как мы. Жестоко? Да. Но это единственный способ выжить. Банк не прощает.")
            print("Ты: Я понимаю вашу ситуацию, но я не дам вам ничего. Эти деньги мне нужны для учебы.")
            print("Коллектор 1: Тогда мы возьмем силой. Извини, но у нас нет выбора. Либо ты, либо мы.")
            print("Ты: У меня тоже нет выбора — я не отдам свои деньги! Если нужно драться — буду драться!")
            print("Коллектор 2: За наши долги!")
            if not mini_battle(p, "Коллекторы", 25):
                return
            print("Отбившись, ты выгодно купил копье на неворованные деньги!")
            art = ab.take('копье')
            if art:
                p.add_art(art)
    elif p.prog == 1:
        print("Ты в таверне. Что дальше?")
        print("Ты: Может, Лексус что-то знает.")
        print("1. Поговорить с Лексусом")
        print("2. Пойти в подвал")
        ch = input("Выбор: ")
        if ch == '1':
            p.prog = 3
            print("Лексус соглашается помочь, но сначала просит выгнать дебошира.")
            print("Лексус: Выгони его, и я помогу.")
            print("Ты: Ладно, попробую.")
            print("\nПрогульщик — студент, который пропустил столько пар, что стал призраком таверны. Он не может уйти, пока не сдаст все долги 317 кафедре, но он слишком ленив, чтобы учиться.")
            print("\nПрогульщик: Эй, не мешай! Я тут... эм... готовлюсь к экзамену!")
            print("Прогульщик: Знаешь, я когда-то был нормальным студентом. Но потом понял — зачем ходить на пары, если можно просто... спать? Всё казалось логичным.")
            print("Ты: И как это сработало? Ты сдал экзамены?")
            print("Прогульщик: Не очень. Теперь я застрял здесь навсегда. Лексус говорит, что я должен сдать все долги, но я слишком ленив. И честно говоря, мне здесь нравится.")
            print("Ты: Может, стоит начать учиться? Я могу помочь, если хочешь.")
            print("Прогульщик: Нет уж! Проще драться с такими, как ты, чем открывать учебник! По крайней мере, драка интереснее!")
            print("Прогульщик: За мою свободу от учебы!")
            if not mini_battle(p, "Прогульщик", 10):
                return
            print("Лексус благодарен и дает тебе лупу!")
            print("Лексус: Ты нормально дерешься, вот держи, пригодится на экзамене, а у него хп мало, лох.")
            art = ab.take('лупа')
            if art:
                p.add_art(art)
        elif ch == '2':
            p.prog = 4
            print("В подвале ты сталкиваешься с Железным Человеком!")
            print("\nЖелезный человек — изобретатель, который застрял в подвале таверны, работая над своим костюмом. Он настолько увлечен работой, что нападает на всех, кто мешает.")
            print("\nЖелезный человек: Стоп! Не мешай! Я работаю над важным проектом!")
            print("Железный человек: Я создаю костюм, который изменит мир! Но мне нужна тишина и покой. Никаких отвлекающих факторов!")
            print("Ты: Я просто хочу пройти через подвал. Я буду очень осторожен, обещаю.")
            print("Железный человек: Пройти? А что, если ты случайно зацепишь Джарвиса? Я работал над ним три месяца! Три месяца без сна!")
            print("Ты: Я понимаю твою обеспокоенность, но мне действительно нужно пройти. Я буду максимально осторожен.")
            print("Железный человек: Осторожен? Я не верю! Люди тупые, они всегда что-то ломают! Лучше я сам защищу свой костюм! Если нужно драться — буду драться!")
            print("Железный человек: За науку!")
            if not mini_battle(p, "Железный человек", 50):
                return
            print("Победив его, ты находишь маску!")
            art = ab.take('маска')
            if art:
                p.add_art(art)
    elif p.prog == 2:
        print("Ты на рынке. Что делать?")
        print("Ты: Может, тут что-то ценное найдется.")
        print("1. Торговать")
        print("2. Искать редкие товары")
        ch = input("Выбор: ")
        if ch == '1':
            p.prog = 5
            print("Контрагент оказывается жуликом, начинается потасовка!")
            print("\nПлохой парень — мошенник, который когда-то был честным торговцем, но обман стал для него образом жизни. Он не может остановиться, даже когда хочет.")
            print("\nПлохой парень: Эй, друг! У меня есть отличное предложение!")
            print("Плохой парень: Я когда-то был честным. Но честность не приносит денег, понимаешь? А деньги... деньги важнее.")
            print("Ты: Я не хочу иметь с тобой дело. Верни мои деньги, и мы разойдемся мирно.")
            print("Плохой парень: О, но ты уже имеешь дело! Я тебя обманул, и что ты сделаешь? Пожалуешья в деканат? Ха! Здесь нет полиции, здесь только сила!")
            print("Ты: Тогда я сделаю то, что должен — верну свои деньги силой. Если ты не хочешь отдать мне их добровольно.")
            print("Плохой парень: Сила? Отлично! Я люблю драки больше, чем честную торговлю! По крайней мере, в драке всё честно!")
            if not mini_battle(p, "Плохой парень", 35):
                return
            print("Удачно продал и получил кольцо!")
            art = ab.take('кольцо')
            if art:
                p.add_art(art)
        elif ch == '2':
            p.prog = 6
            print("Охранник общаги не пускает тебя к редким товарам!")
            print("\nОхранник общаги — бывший военный, который слишком серьезно относится к своей работе. Он охраняет редкие товары, которые когда-то принадлежали студентам, не сдавшим сессию.")
            print("\nОхранник общаги: Стоп! Сюда нельзя! Это закрытая территория!")
            print("Охранник общаги: Я служил в армии двадцать лет. Дисциплина — это всё, что я знаю. Приказ есть приказ.")
            print("Ты: Мне нужно попасть туда. Там могут быть важные материалы для моего экзамена.")
            print("Охранник общаги: Нужно? А мне нужно выполнять приказ! И приказ гласит — никого не пускать! Никаких исключений!")
            print("Ты: Но там могут быть важные вещи для экзамена! Может, можно сделать исключение?")
            print("Охранник общаги: Экзамен? Я не знаю, что это такое. Я знаю только приказ. И если ты не уйдешь — я применю силу! Это мой долг!")
            if not mini_battle(p, "Охранник общаги", 40):
                return
            print("После победы ты находишь редкую книгу!")
            art = ab.take('книга')
            if art:
                p.add_art(art)
    else:
        print("Ветка завершена! Возврат в меню.")
        p.branch = 0
        p.prog = 0

def branch_3(p, ab):
    # Сюжетная ветка 3 — ПОДЗЕМЕЛЬЕ
    print("\nПОДЗЕМЕЛЬЕ")
    if p.prog == 0:
        print("Ты спустился в подземелье. Две двери.")
        print("Ты: Не нравится мне это место.")
        print("1. Левая дверь")
        print("2. Правая дверь")
        ch = input("Выбор: ")
        if ch == '1':
            p.prog = 1
            print("За левой дверью угорает Джокер!")
            print("\nДжокер — безумный преступник, который когда-то был обычным человеком, но трагедия превратила его в символ хаоса. Он охраняет левую дверь подземелья, считая её своим королевством.")
            print("\nДжокер: О, новый гость! Как интересно... ты выглядишь серьезным. Я ненавижу серьезных людей. Особенно Бетмэна")
            print("Джокер: Знаешь, почему я улыбаюсь? Потому что жизнь — это шутка. И я — главный шутник!")
            print("Ты: Мне нужно пройти.")
            print("Джокер: Пройти? А что, если я не хочу тебя пропускать? Что, если я хочу посмотреть, как ты будешь пытаться? Ты же не работаешь на Бетмэна?")
            print("Ты: Нет не работаю. Тогда мне придется драться.")
            print("Джокер: Драться? Отлично! Я люблю драки! Особенно когда я выигрываю! Особенно Бетмэна! АХАХАХАХХАХА!")
            if not mini_battle(p, "Джокер", 45):
                return
            print("В левой комнате нашел щит!")
            art = ab.take('щит')
            if art:
                p.add_art(art)
        elif ch == '2':
            p.prog = 2
            print("За правой дверью поджидает Локи!")
            print("\nЛоки — бог обмана и хитрости, который попал в подземелье после неудачной попытки захватить трон. Он охраняет ключ, который может открыть портал обратно в Асгард.")
            print("\nЛоки: О, смертный... ты пришел за моим ключом? Интересно, как ты думаешь его получить?")
            print("Локи: Я бог обмана, понимаешь? Я могу обмануть кого угодно. Но ты... ты выглядишь честным. Это скучно. Где же веселье?")
            print("Ты: Мне нужен этот ключ. Он может помочь мне в важном деле.")
            print("Локи: Нужен? А что, если я скажу, что это не настоящий ключ? Что, если я уже обманул тебя, и ты даже не заметил? Интересно, не так ли?")
            print("Ты: Тогда мне придется проверить это в бою. Если ты обманываешь — я это узнаю. Жалко с тобой драться, ты красавчик...")
            print("Локи: Бой? Ха! Я предпочитаю обманывать, но если ты настаиваешь... пусть будет бой! Хотя я предупреждаю — я не играю честно!")
            print("Локи: За Асгард! Нет, постой... за себя!")
            if not mini_battle(p, "Локи", 50):
                return
            print("В правой комнате нашел ключ!")
            art = ab.take('ключ')
            if art:
                p.add_art(art)
    elif p.prog == 1:
        print("Ты в левой комнате. Дальше?")
        print("Ты: Впереди ещё темнее, но надо идти.")
        print("1. Идти глубже")
        print("2. Вернуться назад")
        ch = input("Выбор: ")
        if ch == '1':
            p.prog = 3
            print("На пути глубже в подземелье тебя атакует Дарт Вейдер!")
            print("\nДарт Вейдер — падший джедай, который когда-то был героем, но страх и гнев превратили его в слугу темной стороны. Он охраняет глубины подземелья, считая их своим убежищем.")
            print("\nДарт Вейдер: Ты здесь лишний, молодой джедай. Уйди, пока не поздно.")
            print("Дарт Вейдер: Я когда-то был как ты — полон надежд и веры в добро. Но реальность жестока.")
            print("Ты: Мне нужно пройти дальше. Я не могу повернуть назад.")
            print("Дарт Вейдер: Дальше? Там только тьма и отчаяние. Я знаю, о чем говорю — я живу там. Ты не готов к тому, что тебя ждет.")
            print("Ты: Мне всё равно, я должен идти. У меня есть цель, и я не отступлю.")
            print("Дарт Вейдер: Тогда ты ошибаешься. Я когда-то был как ты — полон решимости. Но тьма поглотила меня. И я покажу тебе, насколько ты ошибся!")
            print("Дарт Вейдер: Я чувствую в тебе Силу... но она слаба!")
            if not mini_battle(p, "Дарт Вейдер", 55):
                return
            print("Глубже нашел посох!")
            art = ab.take('посох')
            if art:
                p.add_art(art)
        elif ch == '2':
            p.prog = 4
            print("По дороге назад на тебя нападает Воландеморт!")
            print("\nВоландеморт — темный маг, который когда-то пытался стать бессмертным, но его планы провалились. Теперь он бродит по подземелью, ища способ вернуть свою силу.")
            print("\nВоландеморт: Кто смеет нарушать мой покой? Ты, смертный?")
            print("Воландеморт: Я когда-то был величайшим магом. Но страх смерти сделал меня слабым. Теперь я застрял здесь, в этом подземелье.")
            print("Ты: Мне нужно вернуться назад. Я не хочу быть здесь.")
            print("Воландеморт: Назад? Нет, никто не уходит отсюда. Это мое королевство, и ты — мой пленник! Ты останешься здесь навсегда!")
            print("Ты: Я не буду пленником. Я выйду отсюда, даже если мне придется драться с тобой.")
            print("Воландеморт: Тогда ты будешь мертв! Я не проигрываю! Авада Кедавра!")
            print("Воландеморт: Ты не можешь победить меня!")
            if not mini_battle(p, "Воландеморт", 45):
                return
            print("Вернувшись, нашел копье!")
            art = ab.take('копье')
            if art:
                p.add_art(art)
    elif p.prog == 2:
        print("Ты в правой комнате. Что дальше?")
        print("Ты: Тут тихо, но это подозрительно.")
        print("1. Открыть сундук")
        print("2. Искать секрет")
        ch = input("Выбор: ")
        if ch == '1':
            p.prog = 5
            print("Сундук охраняет гоблин!")
            print("\nГоблин — маленькое существо, которое когда-то было обычным человеком, но проклятие превратило его в жадного хранителя сокровищ. Он охраняет сундук, не зная, что внутри.")
            print("\nГоблин: Мое! Мое сокровище! Никто не возьмет!")
            print("Гоблин: Я когда-то был человеком... но жадность погубила меня. Теперь я охраняю сокровища, которые никогда не смогу использовать. Но они мои!")
            print("Ты: Мне нужно открыть сундук. Там может быть что-то важное для меня.")
            print("Гоблин: Нет! Это мое! Я охранял его сто лет! Сто лет! И ты думаешь, что можешь просто прийти и взять? Ты сначала арену в Клеш рояле аппни, а потом поговорим!")
            print("Ты: Но ты же не можешь его использовать. Зачем охранять то, что тебе не нужно?")
            print("Гоблин: Не важно! Это мое! Моё сокровище! И я буду драться за него до последнего,тратить элексир! Даже если это бессмысленно!")
            print("Гоблин: За мое сокровище!")
            if not mini_battle(p, "гоблин", 50):
                return
            print("В сундуке нашел лупу!")
            art = ab.take('лупа')
            if art:
                p.add_art(art)
        elif ch == '2':
            p.prog = 6
            print("Пока ты ищешь секрет, на тебя нападает сессия!")
            print("\nСессия — мистическое существо, которое появляется раз в полгода и преследует всех студентов. Она не может быть побеждена полностью, но её можно временно отогнать.")
            print("\nСессия: О, студент... я чувствую твой страх. Ты не готов, не так ли?")
            print("Сессия: Я существую столько, сколько существуют студенты. Я — их страх, их кошмар, их неизбежность. Я всегда прихожу, и никто не может избежать меня.")
            print("Ты: Мне нужно найти секретную дверь. Я слышал, что она где-то здесь.")
            print("Сессия: Секретную дверь? Ха! Единственный секрет — это то, что ты не готов. Никогда не готов. Никто не готов.")
            print("Ты: Я попробую всё равно. Я должен найти её, даже если мне придется драться с тобой.")
            print("Сессия: Попробуй. Но помни — я всегда возвращаюсь. И в следующий раз я буду сильнее! Ты не можешь избежать меня навсегда!")
            if not mini_battle(p, "сессия", 80):
                return
            print("Нашел секретную дверь и маску!")
            art = ab.take('маска')
            if art:
                p.add_art(art)
    else:
        print("Ветка завершена! Возврат в меню.")
        p.branch = 0
        p.prog = 0

def game_loop(p, ab):
    # Главный игровой цикл после входа в игру
    # Здесь игрок выбирает ветку, сохраняется, выходит и тд

    while True:
        if p.branch == 0:
            print(f"\n=== ИГРА ===")
            print(f"Игрок: {p.n}")
            print(f"HP: {p.hp}/{p.max_hp} | Мана: {p.mana}/{p.max_mana}")
            print(f"Артефакты: {', '.join(p.art) if p.art else 'нет'}")
            print("\nВыбери ветку:")
            print("1. Лес")
            print("2. Город")
            print("3. Подземелье")
            print("4. Сохранить")
            print("5. Выход")
            print("6. Обменять артефакт на HP")
            ch = input("Выбор: ")
            if ch == '1':
                p.branch = 1
                p.prog = 0
                p.saved = False
            elif ch == '2':
                p.branch = 2
                p.prog = 0
                p.saved = False
            elif ch == '3':
                p.branch = 3
                p.prog = 0
                p.saved = False
            elif ch == '4':
                p.save(f"save_{p.n}.json")
                ab.save("artifacts.json")
            elif ch == '5':
                if not p.saved:
                    print("\nВНИМАНИЕ! Прогресс не сохранен!")
                    print("Все артефакты вернутся в копилку!")
                    ans = input("Выйти без сохранения? (да/нет): ")
                    if ans.lower().startswith('д'):
                        ab.return_art(p.art)
                        p.art = []
                        p.prog = 0
                        p.branch = 0
                        print("Прогресс сброшен, артефакты возвращены.")
            elif ch == '6':
                trade_art_for_hp(p, ab)
        elif p.branch == 1:
            branch_1(p, ab)
        elif p.branch == 2:
            branch_2(p, ab)
        elif p.branch == 3:
            branch_3(p, ab)
        
        if ab.is_empty():
            ab.gen_new()

def main():
    # Точка входа в игру.
    # Отвечает за приветствие, регистрацию/авторизацию, загрузку/сохранение и запуск основного игрового цикла
    print("Добро пожаловать в «АРТЕФАКТЫ»!")
    print("Здесь ты будешь не просто нажимать кнопки - ты будешь делать выбор. Каждое твоё решение в Лесу, Городе или Подземелье изменит историю. Ты найдёшь уникальные артефакты, сразишься с неожиданными врагами и повысишь свой уровень. Можно сказать, игра про нас же: бродишь по локациям, сдаёшь сессию преподам (дерешься с популярными героями и злодеями), собираешь артефакты (как шпоры, только легально).")
    print("Но помни главное:  сохранения нет по умолчанию - сам решаешь, когда сохраниться. Если вышел без сохранения - всё, прогресс сгорел, артефакты вернулись в копилку. Прям как с лабами: не сдал вовремя - начинай заново.")
    print("Код написан в лучших традициях «работает - не трогай», так что если что, не судите строго, я девочка. Запускайте, тестируйте, находите баги - пишите, исправлю. И да, если соберёте все артефакты - вам респект.")
    print("Готовы ли вы к настоящему приключению, где каждая ветка ведёт к новой тайне, а каждая победа делает тебя сильнее? Удачи, друзья. Ваш путь начинается сейчас)")
    print("")
    print("")
    print("=== ИГРА ===")
    login = None
    while not login:
        ch = main_menu()
        if ch == '1':
            login = reg()
        elif ch == '2':
            login = auth()
        elif ch == '3':
            return
    
    p = P(login)
    ab = ABox()
    
    if os.path.exists(f"save_{login}.json"):
        ans = input("Найдено сохранение. Загрузить? (да/нет): ")
        if ans.lower().startswith('д'):
            p.load(f"save_{login}.json")
            ab.load("artifacts.json")
            p.saved = True
    
    game_loop(p, ab)
    
    if not p.saved:
        print("\nВНИМАНИЕ! Прогресс не сохранен!")
        ans = input("Сохранить перед выходом? (да/нет): ")
        if ans.lower().startswith('д'):
            p.save(f"save_{login}.json")
            ab.save("artifacts.json")
        else:
            ab.return_art(p.art)
            print("Артефакты возвращены в копилку.")

if __name__ == "__main__":
    main()

